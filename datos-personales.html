function actualizarFechaHora() {
    const ahora = new Date();
    const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
    const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
    const fechaFormateada = ahora.toLocaleDateString('es-AR', opcionesFecha);
    const horaFormateada = ahora.toLocaleTimeString('es-AR', opcionesHora);
    document.getElementById('fecha-hora').textContent = `${fechaFormateada} - ${horaFormateada}`;
}
setInterval(actualizarFechaHora, 1000);
actualizarFechaHora();

async function cargarCotizaciones() {
    const target = document.getElementById('dolar-cotizaciones');
    const urls = {
        blue: 'https://dolarapi.com/v1/dolares/blue',
        oficial: 'https://dolarapi.com/v1/dolares/oficial',
        mep: 'https://dolarapi.com/v1/dolares/bolsa'
    };

    try {
        const responses = await Promise.allSettled(Object.values(urls).map(url => fetch(url)));
        let html = '';
        const labels = { blue: 'Blue', oficial: 'Oficial', mep: 'MEP' };

        for (const [index, result] of responses.entries()) {
            const type = Object.keys(urls)[index];
            const label = labels[type];

            if (result.status === 'fulfilled' && result.value.ok) {
                const data = await result.value.json();
                if (typeof data.compra === 'number' && typeof data.venta === 'number') {
                    html += `<p><strong>Dólar ${label}:</strong> Compra $${data.compra.toFixed(2)} - Venta $${data.venta.toFixed(2)}</p>`;
                } else {
                    html += `<p style="color:crimson;">Error: Datos inválidos para Dólar ${label}</p>`;
                }
            } else {
                html += `<p style="color:crimson;">Error al cargar Dólar ${label}</p>`;
            }
        }
        
        // Agregar cotizaciones estáticas para Cripto, ya que no tienes una API para ellas.
        html += `<div style="margin-top: 30px;">
                    <h3>Cotizaciones Criptomonedas Populares</h3>
                    <div id="cripto-cotizaciones">
                        <p>Bitcoin (BTC): <strong>$110.500.000 ARS</strong> <span>(+1.5%)</span></p>
                        <p>Ethereum (ETH): <strong>$6.050.000 ARS</strong> <span>(-0.2%)</span></p>
                        <p style="font-size:10px;color:#666;">Fuente: Binance / CryptoYa (Datos estáticos de ejemplo)</p>
                    </div>
                </div>`;
        
        html += `<p style="font-size:12px;color:#666;margin-top:8px;">Última actualización de divisas: ${new Date().toLocaleString('es-AR')}</p>`;
        target.innerHTML = html;

    } catch (err) {
        target.innerHTML = `<p style="color:crimson;">Error general al cargar cotizaciones.</p>`;
    }
}
cargarCotizaciones();
setInterval(cargarCotizaciones, 60000);

async function cargarNoticias() {
    const noticiasLista = document.getElementById('noticias-lista');
    noticiasLista.innerHTML = '<li>Cargando noticias... Si no cargan, el servidor proxy podría estar caído.</li>';

    // Usamos el proxy para intentar acceder a la fuente de noticias (La Nación)
    const proxy = 'https://api.allorigins.win/get?url=';
    const rssFeeds = [
        { name: 'La Nación (Economía)', url: 'https://www.lanacion.com.ar/arc/outboundfeeds/rss/economia/', limit: 5 }
    ];

    let allNewsItems = [];

    try {
        const results = await Promise.allSettled(
            rssFeeds.map(feed =>
                fetch(proxy + encodeURIComponent(feed.url))
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error HTTP ${response.status} para ${feed.name}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(data.contents, "text/xml");
                        const items = xml.querySelectorAll('item');
                        const newsFromFeed = [];
                        items.forEach((item, i) => {
                            if (i >= feed.limit) return;

                            const title = item.querySelector('title')?.textContent || 'Sin título';
                            const link = item.querySelector('link')?.textContent || '#';
                            const pubDate = item.querySelector('pubDate')?.textContent || '';
                            const descriptionHtml = item.querySelector('description')?.textContent || '';

                            let imgSrc = '';
                            let cleanDescriptionText = '';
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = descriptionHtml;

                            const imgElement = tempDiv.querySelector('img');
                            if (imgElement) {
                                imgSrc = imgElement.src;
                                imgElement.remove();
                            }
                            cleanDescriptionText = tempDiv.textContent || '';
                            const shortText = cleanDescriptionText.substring(0, 140) + (cleanDescriptionText.length > 140 ? '...' : '');

                            const fecha = pubDate ? new Date(pubDate).toLocaleDateString('es-AR', {year:'numeric', month:'short', day:'numeric'}) : 'Fecha desconocida';

                            newsFromFeed.push({
                                title,
                                link,
                                shortText,
                                fecha,
                                imgSrc,
                                source: feed.name
                            });
                        });
                        return newsFromFeed;
                    })
            )
        );

        results.forEach(result => {
            if (result.status === 'fulfilled') {
                allNewsItems = allNewsItems.concat(result.value);
            }
        });

        allNewsItems.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        let html = '';
        if (allNewsItems.length === 0) {
            html = '<li>No se pudieron cargar noticias. El proxy (allorigins.win) o la fuente están fallando.</li>';
        } else {
            allNewsItems.forEach(news => {
                html += `<li>
                    ${news.imgSrc ? `<img src="${news.imgSrc}" alt="${news.title}">` : ''}
                    <a href="${news.link}" target="_blank" rel="noopener noreferrer">${news.title}</a>
                    <p>${news.shortText}</p>
                    <time>${news.fecha} - <span style="font-weight: bold;">${news.source}</span></time>
                </li>`;
            });
        }
        noticiasLista.innerHTML = html;

    } catch(e) {
        noticiasLista.innerHTML = '<li style="color:crimson;">Error general en el proceso de carga de noticias.</li>';
    }
}
cargarNoticias();
setInterval(cargarNoticias, 5 * 60 * 1000);
